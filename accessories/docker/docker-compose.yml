# ==============================================================================
# Docker Compose setup for EDS (Encrypted Data Share)
# ------------------------------------------------------------------------------
# This setup creates two containers:
# - PostgreSQL database with persistent storage
# - Quarkus application running the EDS service
#
# Usage:
#   Build the Quarkus JAR first: mvn -pl eds-quarkus -am clean package -DskipTests
#   Then run: docker compose up -d
# ==============================================================================

services:
  # PostgreSQL Database
  eds-db:
    image: postgres:16-alpine
    container_name: eds-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
      TZ: Europe/Berlin
    volumes:
      - ./volumes/data:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh:ro
      - ../release/postgresql/02-init.sql:/docker-entrypoint-initdb.d/sql/02-init.sql:ro
      - ../release/postgresql/03-create.sql:/docker-entrypoint-initdb.d/sql/03-create.sql:ro
      - ../release/postgresql/04-update-1.sql:/docker-entrypoint-initdb.d/sql/04-update-1.sql:ro
      - ../release/postgresql/04-update-2.sql:/docker-entrypoint-initdb.d/sql/04-update-2.sql:ro
      - ../release/postgresql/04-update-3.sql:/docker-entrypoint-initdb.d/sql/04-update-3.sql:ro
    networks:
      - eds-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U eds_user -d eds"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # Quarkus Application
  eds-app:
    build:
      context: ../..
      dockerfile: accessories/docker/Dockerfile.quarkus
    container_name: eds-quarkus
    environment:
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://eds-db:5432/eds
      QUARKUS_DATASOURCE_USERNAME: eds_user
      QUARKUS_DATASOURCE_PASSWORD: eds
      QUARKUS_LOG_FILE_ENABLE: true
      QUARKUS_LOG_FILE_PATH: /app/logs/eds.log
      QUARKUS_LOG_FILE_ROTATION_MAX_FILE_SIZE: 10M
      QUARKUS_LOG_FILE_ROTATION_MAX_BACKUP_INDEX: 5
      TZ: Europe/Berlin
    volumes:
      - ./volumes/logs:/app/logs
    ports:
      - "8080:8080"
    networks:
      - eds-network
    depends_on:
      eds-db:
        condition: service_healthy

# Internal network for container communication
networks:
  eds-network:
    driver: bridge
